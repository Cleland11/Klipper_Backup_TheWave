[gcode_macro PRINT_START]
description: Customized start macro with ABS/ASA heat soak and Nevermore activation
gcode:
    # Parameters from slicer
    {% set BED_TEMP      = params.BED_TEMP|default(60)|float %}
    {% set HOTEND_TEMP   = params.HOTEND_TEMP|default(210)|float %}
    {% set FILAMENT_TYPE = params.FILAMENT_TYPE|default("PLA")|string|upper %}  ; ← fixed name + default + upper

    # Store filament type so PRINT_END can use it
    SET_GCODE_VARIABLE MACRO=PRINT_END VARIABLE=last_filament VALUE="'{FILAMENT_TYPE}'"

    # Turn on case lights immediately
    SET_LED LED=caselight RED=1 GREEN=1 BLUE=1 WHITE=1 SYNC=0  ; Remove WHITE=1 if RGB only

    STATUS_HEATING
    SET_LED_EFFECT EFFECT=warm_up

    # Start heating (parallel)
    RESPOND MSG="Preheating bed and hotend"
    M117 Preheat
    M140 S{BED_TEMP}                    ; Bed start
    M104 S{HOTEND_TEMP * 0.75}          ; Hotend preheat ~75%

    {% set is_abs_like = "ABS" in FILAMENT_TYPE or "ASA" in FILAMENT_TYPE or BED_TEMP >= 90 %}

    {% if is_abs_like %}
        M190 S{BED_TEMP}  ; Wait for bed to reach target first
        
        {% set current_chamber = printer["temperature_sensor chamber"].temperature|float(0) %}
        
        {% if current_chamber >= 40 %}
            RESPOND MSG="Chamber already {current_chamber|round(1)}°C (>=40°C) - Skipping heat soak"
            M117 No Soak Needed
        {% else %}
            RESPOND MSG="Chamber {current_chamber|round(1)}°C (<40°C) - Starting 5 minute heat soak"
            M117 Heatsoak 5min
            G4 S300  ; Fixed 5 minute dwell (300 seconds)
            RESPOND MSG="5 minute heat soak complete - continuing"
            M117 Soak Complete
        {% endif %}
    {% else %}
        M190 S{BED_TEMP}  ; Normal filaments: just wait for bed
    {% endif %}
    
    # Homing + Meshing
    STATUS_HOMING
    SET_LED_EFFECT EFFECT=case_homing
    M117 Homing
    G28
    Attach_Probe_Lock
    STATUS_MESHING
    M117 Bed Mesh Calibrate
    BED_MESH_CALIBRATE ADAPTIVE=1 SETTLING_SAMPLE=1
    DOCK_PROBE_UNLOCK

    # Final hotend heat
    M109 S{HOTEND_TEMP}

    # Nevermore activation (re-checked after full heat)
    {% if is_abs_like %}
        SET_FAN_SPEED FAN=nevermore SPEED=1.0
        M117 Nevermore ON - {FILAMENT_TYPE}
    {% else %}
        SET_FAN_SPEED FAN=nevermore SPEED=0
        M117 Nevermore OFF
    {% endif %}

    # Final setup
    G90
    M83
    SET_LED LED=caselight RED=1 GREEN=1 BLUE=1 WHITE=1
    LINE_PURGE
    M117 Printing...