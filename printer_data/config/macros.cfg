
[gcode_macro DISABLE_MOTORS]
gcode:
    M18

[idle_timeout]
gcode:
    TURN_OFF_HEATERS
    DISABLE_MOTORS

####################################################################################

[gcode_macro FIRST_LAYER_CALIB_PLA]
description: Bed mesh + 3x3 grid of 40mm squares for PLA first layer calibration
gcode:
    M117 PLA First Layer Calib - Heating Bed
    G28
    M140 S60                               ; Start heating bed

    M117 Preheating
    M190 S60                               ; Wait for bed to come up to temp

    M117 Bed Mesh Calibrating
    BED_MESH_CALIBRATE SETTLING_SAMPLE=1

    M117 Heating
    M109 S210                                ; Heat to 210°C and wait

    M117 Priming Nozzle
    LINE_PURGE

    M117 Printing 3x3 Squares
    _PRINT_SQUARES

    G1 Z20 F3000
    M117 Complete

[gcode_macro FIRST_LAYER_CALIB_ABS]
description: Bed mesh + 3x3 grid of 40mm squares for ABS/ASA first layer calibration
gcode:
    M117 ABS First Layer Calib - Heating Bed
    G28
    M140 S110                                ; Start heating bed
    M117 Preheating
    M104 S150                                ; Start heating hotend
    M190 S110                                ; Wait for bed to reach 110°C

    M117 Bed Mesh Calibrating
    BED_MESH_CALIBRATE SETTLING_SAMPLE=1

    M117 Heating
    M109 S250                                ; Heat to 250°C and wait

    M117 Priming Nozzle
    LINE_PURGE
    M117 Printing 3x3 Squares
    _PRINT_SQUARES

    G1 Z20 F3000
    M117 Complete

[gcode_macro FIRST_LAYER_CALIB_PETG]
description: Bed mesh + 3x3 grid of 40mm squares for PETG first layer calibration
gcode:
    M117 PETG First Layer Calib - Heating Bed
    G28
    M140 S80                                 ; Start heating bed
    M117 Preheating
    M104 S150                                ; Start heating hotend
    M190 S80                                 ; Wait for bed to reach 80°C

    M117 Bed Mesh Calibrating
    BED_MESH_CALIBRATE SETTLING_SAMPLE=1

    M117 Heating
    M109 S240                                ; Heat to 240°C and wait

    M117 Priming Nozzle
    LINE_PURGE

    M117 Printing 3x3 Squares
    _PRINT_SQUARES

    G1 Z20 F3000
    M117 Complete

# Shared routine to avoid duplication
# Helper macro – call this from the menu to request stop
[gcode_macro STOP_CALIB]
description: Request stop of current first-layer calibration squares
gcode:
    SET_GCODE_VARIABLE MACRO=_PRINT_SQUARES VARIABLE=stop_requested VALUE=True
    RESPOND MSG="Stop requested – finishing current square"
    M117 Stop Requested

# Updated shared printing routine – now stoppable
[gcode_macro _PRINT_SQUARES]
gcode:
    {% set square_size = 40.0 %}
    {% set layer_height = 0.2 %}
    {% set line_width = 0.48 %}               ; Adjust if your nozzle/flow differs
    {% set spacing = 30.0 %}
    {% set extrusion_per_mm = (line_width * layer_height) / (1.75**2 * 3.14159 / 4) %}

    {% set infill_speed = 30.0 %}             ; Slow infill speed in mm/s
    {% set perimeter_speed = 25.0 %}          ; Slower perimeter speed

    {% set start_x = 40.0 %}
    {% set start_y = 20.0 %}

    {% set sqrt2 = 2**0.5 %}
    {% set diag = square_size * sqrt2 %}
    {% set num_lines = ((square_size * sqrt2) / line_width)|int + 1 %}

    {% for row in range(3) %}
        {% for col in range(3) %}
            {% set pos_x = start_x + col * (square_size + spacing) %}
            {% set pos_y = start_y + row * (square_size + spacing) %}

            G1 X{pos_x} Y{pos_y} F12000
            G1 Z{layer_height} F1000

            ; 2 Perimeters first
            ; Outer
            G1 X{pos_x + square_size} Y{pos_y} E{(square_size * extrusion_per_mm)|round(4)} F{perimeter_speed * 60}
            G1 X{pos_x + square_size} Y{pos_y + square_size} E{(square_size * extrusion_per_mm)|round(4)} F{perimeter_speed * 60}
            G1 X{pos_x} Y{pos_y + square_size} E{(square_size * extrusion_per_mm)|round(4)} F{perimeter_speed * 60}
            G1 X{pos_x} Y{pos_y} E{(square_size * extrusion_per_mm)|round(4)} F{perimeter_speed * 60}

            ; Inner (offset by line_width)
            {% set inner_offset = line_width %}
            {% set inner_size = square_size - 2 * inner_offset %}
            G1 X{pos_x + inner_offset} Y{pos_y + inner_offset} F12000
            G1 X{pos_x + inner_offset + inner_size} Y{pos_y + inner_offset} E{(inner_size * extrusion_per_mm)|round(4)} F{perimeter_speed * 60}
            G1 X{pos_x + inner_offset + inner_size} Y{pos_y + inner_offset + inner_size} E{(inner_size * extrusion_per_mm)|round(4)} F{perimeter_speed * 60}
            G1 X{pos_x + inner_offset} Y{pos_y + inner_offset + inner_size} E{(inner_size * extrusion_per_mm)|round(4)} F{perimeter_speed * 60}
            G1 X{pos_x + inner_offset} Y{pos_y + inner_offset} E{(inner_size * extrusion_per_mm)|round(4)} F{perimeter_speed * 60}

            ; 45-degree monotonic infill (parallel lines at 45°)
            ; Infill area: inside the 2 perimeters
            {% set fill_x = pos_x + 2 * line_width %}
            {% set fill_y = pos_y + 2 * line_width %}
            {% set fill_size = square_size - 4 * line_width %}

            ; Move to start of first line (bottom-left)
            G1 X{fill_x} Y{fill_y} F12000

            {% for i in range(num_lines) %}
                {% set offset = i * line_width %}
                {% set line_start_x = fill_x + offset * (-sqrt2 / 2)|round(4) %}
                {% set line_start_y = fill_y + offset * (sqrt2 / 2)|round(4) %}

                ; Clip start to bounds
                {% set start_x_clipped = [line_start_x, fill_x]|max %}
                {% set start_y_clipped = [line_start_y, fill_y]|max %}

                ; Calculate corresponding end point
                {% set rel_offset_x = start_x_clipped - line_start_x %}
                {% set rel_offset_y = start_y_clipped - line_start_y %}
                {% set end_x = fill_x + fill_size + rel_offset_x * (sqrt2 / 2) / (-sqrt2 / 2) %}
                {% set end_y = fill_y + fill_size + rel_offset_y * (sqrt2 / 2) / (sqrt2 / 2) %}

                ; Clip end to bounds
                {% set end_x_clipped = [end_x, fill_x + fill_size]|min %}
                {% set end_y_clipped = [end_y, fill_y + fill_size]|min %}

                ; Length of this segment
                {% set dx = end_x_clipped - start_x_clipped %}
                {% set dy = end_y_clipped - start_y_clipped %}
                {% set length = (dx**2 + dy**2)**0.5 %}

                ; Skip if too short
                {% if length > line_width / 2 %}
                    G1 X{start_x_clipped} Y{start_y_clipped} F12000
                    G1 X{end_x_clipped} Y{end_y_clipped} E{(length * extrusion_per_mm)|round(4)} F{infill_speed * 60}
                {% endif %}
            {% endfor %}

            G1 Z5 F3000
        {% endfor %}
    {% endfor %}
    
####################################################################################

[gcode_macro PREHEAT_CHAMBER]
description: Preheat chamber (interruptible polling): Conditional home, Park center, Nevermore on, fan 40%, heat bed to 110°C + hotend to 190°C (background), poll chamber until >=40°C then fan off
gcode:
    # Safety check
    {% if printer.idle_timeout.state == "Printing" %}
        {action_respond_info("Cannot preheat chamber while printing!")}
        CANCEL_PRINT
    {% endif %}

    # Conditional homing if needed
    {% if "xyz" not in printer.toolhead.homed_axes %}
        {action_respond_info("Not fully homed - running G28")}
        G28
    {% else %}
        {action_respond_info("Already homed - skipping G28")}
    {% endif %}

    PARKCENTER
    NEVERMORE_ON
    G4 P3000                        ; Wait 3s for Nevermore spin-up
    M106 S102                       ; Part fan 40% to circulate

    # Heat bed to 110°C (background)
    M140 S110

    # Heat hotend to 190°C (background - safe pre-warm for ABS, prevents oozing)
    M104 S190

    # Kick off the polling loop for chamber
    UPDATE_DELAYED_GCODE ID=chamber_poll DURATION=30  ; Start checking in 30s

    {action_respond_info("Chamber preheating - bed to 110°C, hotend to 190°C (background), polling every 10s until >=40°C")}

# Polling loop - checks chamber temp, reschedules if not ready, finishes when >=40°C
[delayed_gcode chamber_poll]
gcode:
    {% set chamber_temp = printer["temperature_sensor chamber"].temperature|float %}
    
    {% if chamber_temp >= 40 %}
        M107                                ; Turn off part cooling fan
        {action_respond_info("Chamber >=40°C reached! Fan off - preheat complete. Hotend at ~190°C, bed at 110°C")}
        # Optional: If you want Nevermore off too → NEVERMORE_OFF
    {% else %}
        # Not ready → log current temp and reschedule in 10s
        {action_respond_info("Chamber at %.1f°C - still preheating, checking again in 10s" % (chamber_temp))}
        UPDATE_DELAYED_GCODE ID=chamber_poll DURATION=10
    {% endif %}

    {action_respond_info("Chamber preheat complete - >=40°C, bed at 110°C, part fan off")}

[delayed_gcode chamber_preheat_timeout]
gcode:
    M107
    {action_respond_info("Chamber preheat timeout after 30min - fan off")}

####################################################################################

[delayed_gcode gradual_cooldown]
gcode:
    {% if printer.heater_bed.target > 40 %}
        M118 Reduce temp to {% set new_temp = printer.heater_bed.target - 5 %}{new_temp}°C.
        M140 S{new_temp}
        UPDATE_DELAYED_GCODE ID=gradual_cooldown DURATION=300
    {% else %}
        M118 Gradual bed cooling finished. Turning off bed.
        M140 S0
        M81
    {% endif %}   
    
####################################################################################

[gcode_macro NEVERMORE_ON]
description: Turn Nevermore filter fan on (full speed)
gcode:
    SET_FAN_SPEED FAN=nevermore SPEED=1.0
    M117 Nevermore On

[gcode_macro NEVERMORE_OFF]
description: Turn Nevermore filter fan off
gcode:
    SET_FAN_SPEED FAN=nevermore SPEED=0
    M117 Nevermore Off

[gcode_macro TOGGLE_NEVERMORE]
description: Toggle Nevermore filter fan on/off
gcode:
    {% if printer.nevermore.speed > 0 %}
        NEVERMORE_OFF
    {% else %}
        NEVERMORE_ON
    {% endif %}

####################################################################################
    
# Park front center
[gcode_macro PARKFRONT]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28                           ; home if not already homed
    {% endif %}
    SAVE_GCODE_STATE NAME=PARKFRONT
    G90                               ; absolute positioning
    G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y+5} Z{printer.toolhead.axis_maximum.z/2} F6000        
    RESTORE_GCODE_STATE NAME=PARKFRONT

# Park front center, but low down.
[gcode_macro PARKFRONTLOW]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28                           ; home if not already homed
    {% endif %}
    SAVE_GCODE_STATE NAME=PARKFRONT
    G90                              ; absolute positioning
    G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y+5} Z20 F6000                                     
    RESTORE_GCODE_STATE NAME=PARKFRONT

# Park top rear left
[gcode_macro PARKREAR]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28                           ; home if not already homed
    {% endif %}
    SAVE_GCODE_STATE NAME=PARKREAR
    G90                              ; absolute positioning
    G0 X{printer.toolhead.axis_minimum.x+10} Y{printer.toolhead.axis_maximum.y-10} Z{printer.toolhead.axis_maximum.z-50} F6000     
    RESTORE_GCODE_STATE NAME=PARKREAR

# Park at center of build volume
[gcode_macro PARKCENTER]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28                           ; home if not already homed
    {% endif %}
    SAVE_GCODE_STATE NAME=PARKCENTER
    G90                               ; absolute positioning
    G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} Z{printer.toolhead.axis_maximum.z/2} F6000    
    RESTORE_GCODE_STATE NAME=PARKCENTER

# Park 5mm above center of bed
[gcode_macro PARKBED]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28                           ; home if not already homed
    {% endif %}
    SAVE_GCODE_STATE NAME=PARKBED
    G90                                ; absolute positioning
    G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} Z5 F6000                                     
    RESTORE_GCODE_STATE NAME=PARKBED

####################################################################################
[pause_resume]
# Intentionaly empty

[gcode_macro M109]
rename_existing: M99109
gcode:
    #Parameters
    {% set s = params.S|float %}
    
    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  ; Set hotend temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s} MAXIMUM={s+1}   ; Wait for hotend temp (within 1 degree)
    {% endif %}

[gcode_macro M190]
rename_existing: M99190
gcode:
    #Parameters
    {% set s = params.S|float %}

    M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}   ; Set bed temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s} MAXIMUM={s+1}  ; Wait for bed temp (within 1 degree)
    {% endif %}


[gcode_macro M600]
gcode:
    M400
    SAVE_GCODE_STATE NAME=M600
    BASE_PAUSE ; This is PAUSE, renamed in mainsail.cfg. Use just PAUSE if you don't have mainsail.cfg.
    G91
    G1 E-.8 F2700
    G1 Z20 F900 ;Raise Z 20mm
    G90
    M400
    SAVE_GCODE_STATE NAME=M600_ABOVE_PRINT
    G1 X15 Y0 F17000 ;Move printhead to front left corner
    M400
    SAVE_GCODE_STATE NAME=M600_FRONT_LEFT_CORNER
    ; At this point user is expected to manualy change filament, and hit M600_DONE when finished.

[gcode_macro DONE_M600]
gcode:
    M400
    G91
    G1 E-.1 F2700
    G90
    RESTORE_GCODE_STATE NAME=M600_FRONT_LEFT_CORNER MOVE=1 MOVE_SPEED=17000
    RESTORE_GCODE_STATE NAME=M600_ABOVE_PRINT MOVE=1 MOVE_SPEED=17000
    RESTORE_GCODE_STATE NAME=M600
    BASE_RESUME ; This is RESUME, renamed in mainsail.cfg. Use just RESUME if you don't have mainsail.cfg.
    CLEAR_PAUSE
####################################################################################

[gcode_macro change_filament]
gcode:
    {% set X =              15      %}
    {% set Y =              5     %}
    {% set Z =              20      %}
    {% set UNLOAD_DIST =    -90    %}
    {% set LOAD_DIST =      100     %}
    {% set extruderTemp = params.EXTRUDER_TEMP|default(230)|float %}

    M104 S{extruderTemp}        #set nozzle temperature
    
    #Home if the toolhead doesn't know its position
    {% if printer.toolhead.homed_axes != 'xyz' %}
		G28
	{% endif %}

    G0 X{X} Y{Y} Z{Z} F3000    #move to area where you can easily load filament
    M109 S{extruderTemp}        #wait for nozzle temperature
    M83                         #relative positioning on extruder
    G0 E15 F400                 #extrude filament to get better blob on end
    G0 E{UNLOAD_DIST} F1000     #unload filament
    G4 P15000                   #wait for filament change 30 seconds
    RESPOND PREFIX= MSG="15 seconds left"
    G4 P15000                   #continue waiting
    G92 E0                      #reset extruder
    M83                         #relative positioning on extruder    
    G0 E{LOAD_DIST} F400        #load filament
    G0 E20 F100                 #purge filament
    G0 E-8 F200                 #retract 8mm to avoid leakage
    G92 E0                      #reset extruder

[gcode_macro unload_filament]
gcode:
    {% set X =              15      %}
    {% set Y =              5     %}
    {% set Z =              20      %}
    {% set UNLOAD_DIST =    -90    %}
    {% set extruderTemp = params.EXTRUDER_TEMP|default(230)|float %}

    M104 S{extruderTemp}        #set nozzle temperature
    
    #Home if the toolhead doesn't know its position
    {% if printer.toolhead.homed_axes != 'xyz' %}
		G28
	{% endif %}

    G0 X{X} Y{Y} Z{Z} F3000    #move to area where you can easily load filament
    M109 S{extruderTemp}        #wait for nozzle temperature
    M83                         #relative positioning on extruder
    G0 E7 F400                 #extrude filament to get better blob on end
    G0 E{-5} F2000             #form tip
    G0 E{UNLOAD_DIST} F1000     #unload filament
    G4 P15000                   #wait for filament change 30 seconds
    RESPOND PREFIX= MSG="Remove Filament Now"
    G92 E0                      #reset extruder


[gcode_macro load_filament]
gcode:
    {% set X =              15      %}
    {% set Y =              5     %}
    {% set Z =              20      %}
    {% set LOAD_DIST =      100     %}
    {% set extruderTemp = params.EXTRUDER_TEMP|default(230)|float %}

    M104 S{extruderTemp}        #set nozzle temperature
    
    #Home if the toolhead doesn't know its position
    {% if printer.toolhead.homed_axes != 'xyz' %}
		G28
	{% endif %}

    G0 X{X} Y{Y} Z{Z} F3000    #move to area where you can easily load filament
    M109 S{extruderTemp}        #wait for nozzle temperature
    G4 P15000                   #wait for filament load 15 seconds
    RESPOND PREFIX= MSG="Loading Filament"
    G92 E0                      #reset extruder
    M83                         #relative positioning on extruder    
    G0 E{LOAD_DIST} F400        #load filament
    G0 E20 F100                 #purge filament
    G0 E-8 F200                 #retract 8mm to avoid leakage
    G92 E0                      #reset extruder


#################################################################

[gcode_macro CANCEL_PRINT]
description: Safely abort the current print or macro
rename_existing: CANCEL_PRINT_BASE
gcode:
    M400                     ; Wait for moves to finish
    SDCARD_RESET_FILE        ; Clear the current file
    CLEAR_PAUSE
    TURN_OFF_HEATERS
    M106 S0                  ; Fan off
    G91
    G1 Z10 F3000             ; Raise Z 10mm
    G90
    PARKREAR
    BED_MESH_CLEAR
    CANCEL_PRINT_BASE
    M117 Print Aborted

[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    #Edit this#
    {% set X = 230 %}
    {% set Y = 230 %}
    {% set Z = 20  %}
    ###########
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    G91
    G1 E-1.7 F2100
    G1 Z{Z}
    G90
    G1 X{X} Y{Y} F6000
    G91

[gcode_macro RESUME]
rename_existing: BASE_RESUME
gcode:
    G91
    G1 E1.7 F2100
    G91
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
    BASE_RESUME

#################################################################

[gcode_macro DISPLAY_GCODE_PROGRESS]
variable_parameter_TOTAL_LAYER : 0
variable_parameter_CURRENT_LAYER : 0
variable_parameter_PROGRESS : 0
variable_parameter_REMAIN : 0
gcode:
    #PRINT MSG="Layer:{params.CURRENT_LAYER}/{params.TOTAL_LAYER}  Progress:{params.PROGRESS}%  Remain:{params.REMAIN}" OUTPUT_TARGET=1
    PRINT MSG="GCODE_PROGRESS,{params.CURRENT_LAYER}/{params.TOTAL_LAYER},{params.PROGRESS},{params.REMAIN}" OUTPUT_TARGET=2

[gcode_macro OFF]
gcode:
    M84                                  ; turn steppers off
    TURN_OFF_HEATERS                     ; turn bed / hotend off
    M107                                 ; turn print cooling fan off
    #SET_FAN_SPEED FAN=Exhaust SPEED=0   ; turn exhaust fan off
    #SET_FAN_SPEED FAN=BedFans SPEED=0   ; bed fan off

[gcode_macro SHUTDOWN]
gcode:
    LCDRGB R=0 G=0 B=0                               ; Turn off LCD neopixels (see above for this macro)
    OFF                                              ; Shortcut to turn everything off (see above for this macro)
    {action_respond_info('action:poweroff')}          ; OctoPrint compatible host shutdown
	{action_call_remote_method("shutdown_machine")}   ; Moonraker compatible host shutdown

[menu __main __setup __shutdown]
type: command
enable: {not printer.idle_timeout.state == "Printing"}
name: Shut down
gcode: SHUTDOWN

[menu __main __control __lights on]
type: command
enable: {not printer.idle_timeout.state == "Printing"}
name: Lights on
gcode: LIGHTS_ON

[menu __main __control __lights off]
type: command
enable: {not printer.idle_timeout.state == "Printing"}
name: Lights off
gcode: LIGHTS_OFF

